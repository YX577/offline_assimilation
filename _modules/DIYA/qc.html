
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DIYA.qc &#8212; Improving reanalysis with offline assimilation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Offline assimilation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo_small.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../preface.html">What this is, and why</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../da_for_ds.html">Meteorological Data Assimilation for Data Scientists</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../improving_with_dwr.html">Improving the reanalyses with DWR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../marine_data/marine_data.html">Improving 20CR with ship observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more_than_mslp/more_than_mslp.html">More than just MSLP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../better_than_olr/better_than_olr.html">More than just linear regression?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/offline_assimilation">Get a copy</a></h3>

<ul>
<li><a href="https://github.com/philip-brohan/offline_assimilation"
           rel="nofollow">Github repository</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/offline_assimilation/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for DIYA.qc</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) British Crown Copyright 2017, Met Office</span>
<span class="c1">#</span>
<span class="c1"># This code is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the</span>
<span class="c1"># Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This code is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>

<span class="c1"># Replicate the 20CR2c observations quality control</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">IRData.twcr</span> <span class="k">as</span> <span class="nn">twcr</span>

<div class="viewcode-block" id="qc_plausible_range"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.qc_plausible_range">[docs]</a><span class="k">def</span> <span class="nf">qc_plausible_range</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mf">880.0</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mf">1060.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks the obs value for plausibility.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs (:obj:`pandas.DataFrame`): Observations. Dataframe must have column &#39;value&#39;, and value should have same units as max and min.</span>
<span class="sd">        min (:obj:`float`): Minimum plausible value, defaults to 880.</span>
<span class="sd">        max (:obj:`float`): Maximum plausible value, defaults to 1060.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (:obj:`pandas.Series`): True where obs[&#39;value&#39; between min and max, False otherwise.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">plausible</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="nb">min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="nb">max</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">plausible</span>

<div class="viewcode-block" id="qc_compare_reanalysis"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.qc_compare_reanalysis">[docs]</a><span class="k">def</span> <span class="nf">qc_compare_reanalysis</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;2c&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get 20CR ensemble values at the time and place of each observation.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs (:obj:`pandas.DataFrame`): Observations. Dataframe must have columns &#39;latitude&#39;, &#39;longitude&#39;, and &#39;dtm&#39; - the last a datetime.datetime.</span>
<span class="sd">        variable (:obj:`str`): Which 20CR variable to compare to. Defaults to &#39;prmsl&#39;</span>
<span class="sd">        version (:obj:`str`): Which 20CR version to load data from. Defaults to &#39;2c&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">        :obj:`pandas.Series`: Reanalyis ensemble associated with each observation.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">old_idx</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># index values 0-n</span>
    <span class="n">ob_times</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">results</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ob_time</span> <span class="ow">in</span> <span class="n">ob_times</span><span class="p">:</span>
        <span class="n">ot</span><span class="o">=</span><span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ob_time</span><span class="p">)</span>
        <span class="n">ensemble</span><span class="o">=</span><span class="n">twcr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">ot</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
        <span class="c1"># Units hack - assumes obs in hPa (if prmsl)</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">==</span><span class="s1">&#39;prmsl&#39;</span><span class="p">:</span> 
            <span class="n">ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">/</span><span class="mf">100.0</span> <span class="c1"># to hPa</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span><span class="o">.</span><span class="n">interpolator</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> 
                                       <span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
        <span class="n">this_time</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">][</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ob_time</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">ob_idx</span> <span class="ow">in</span> <span class="n">this_time</span><span class="p">:</span>
            <span class="n">ensemble</span><span class="o">=</span><span class="n">interpolator</span><span class="p">([</span><span class="n">obs</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="n">ob_idx</span><span class="p">],</span><span class="n">obs</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="n">ob_idx</span><span class="p">]])</span>
            <span class="n">results</span><span class="p">[</span><span class="n">ob_idx</span><span class="p">]</span><span class="o">=</span><span class="n">ensemble</span><span class="o">.</span><span class="n">data</span>
</div>
    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">old_idx</span><span class="p">)</span>

<div class="viewcode-block" id="qc_first_guess"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.qc_first_guess">[docs]</a><span class="k">def</span> <span class="nf">qc_first_guess</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">nsd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">osd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">comparison</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">variable</span><span class="o">=</span><span class="s1">&#39;prmsl&#39;</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;2c&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks the obs value against the 20CR ensemble.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs (:obj:`pandas.DataFrame`): Observations. Dataframe must have columns &#39;latitude&#39;, &#39;longitude&#39;, &#39;value&#39;, and &#39;dtm&#39; - the last a datetime.datetime.</span>
<span class="sd">        nsd (:obj:`float`): Number of standard deviations for rejection threshold. Defaults to 3.</span>
<span class="sd">        osd (:obj:`float`): Observation standard deviation. Defaults to 2.</span>
<span class="sd">        comparison (:obj:`pandas.Series`): Reanalysis ensemble values at the time and place of each observation. Defaults to None - calculate them.</span>
<span class="sd">        variable (:obj:`str`): Which 20CR variable to compare to. Defaults to &#39;prmsl&#39;</span>
<span class="sd">        version (:obj:`str`): Which 20CR version to load data from. Defaults to &#39;2c&#39;</span>

<span class="sd">    For each observation, loads the 20CR ensemble at the time of observation, extracts the mean and standard deviation at the time and place of observation, and compares ob-ensemble mean with the expected difference given the ensemble spread and observation error sqrt(ensemble sd**2 + osd**2). If the observed difference is greater than nsd times the expected difference, mark ob with false, otherwise with true.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (:obj:`pandas.Series`): True where ob-ensemble mean within expected difference from 20CR spread, False otherwise.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comparison</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comparison</span><span class="o">=</span><span class="n">qc_compare_reanalysis</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
        <span class="n">ens_mean</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ens_sd</span>    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expected</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">osd</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ens_sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">ens_mean</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">deviation</span><span class="o">/</span><span class="n">expected</span><span class="p">)</span><span class="o">&lt;</span><span class="n">nsd</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
</div>
    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
        
<span class="c1"># Analagous to DWR.at_station_and_time, but gets QC status instead of value</span>
<div class="viewcode-block" id="qc_at_station_and_time"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.qc_at_station_and_time">[docs]</a><span class="k">def</span> <span class="nf">qc_at_station_and_time</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">station</span><span class="p">,</span><span class="n">dte</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get, from these observations, the quality of value at the selected station and time.</span>

<span class="sd">    This is analagous to :func:`DWR.at_station_and_time` except it gets the QC status of the observation instead of its value. If the value is interpolated, it will fail QC if either of the values it&#39;s interpolated from fails.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs (:obj:`pandas.DataFrame`): Batch of observations for the period around the desired time. Should have extra columns &#39;plausible&#39; and &#39;first_guess&#39;, giving results of those QC checks.</span>
<span class="sd">        station (:obj:`str`): Name of station, as used in obs.name.</span>
<span class="sd">        dte (:obj:`datetime.datetime`): Time of required observed value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :obj:`bool`: True if this selected data has passed QC checks.</span>


<span class="sd">    Raises:</span>
<span class="sd">        StandardError: obs does not contain at least two values for selected station, one before and one after specified time. So interpolation not possible.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quality</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">at_station</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">station</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">at_station</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StandardError</span><span class="p">(</span><span class="s1">&#39;No data for station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="p">)</span>
    <span class="n">at_station</span><span class="o">=</span><span class="n">at_station</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;dtm&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hit</span><span class="o">=</span><span class="n">at_station</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at_station</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">dte</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">hit</span><span class="o">=</span><span class="n">hit</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;plausible&#39;</span> <span class="ow">in</span> <span class="n">hit</span><span class="p">:</span> 
            <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;plausible&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;first_guess&#39;</span> <span class="ow">in</span> <span class="n">hit</span><span class="p">:</span> 
            <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;first_guess&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">quality</span>
    <span class="n">before</span><span class="o">=</span><span class="n">at_station</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at_station</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">dte</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">before</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StandardError</span><span class="p">(</span><span class="s1">&#39;No data for station </span><span class="si">%s</span><span class="s1"> before </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span>
                     <span class="n">dte</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">:%H:%M&quot;</span><span class="p">)))</span>
    <span class="n">before</span><span class="o">=</span><span class="n">before</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># last row</span>
    <span class="k">if</span> <span class="s1">&#39;plausible&#39;</span> <span class="ow">in</span> <span class="n">before</span><span class="p">:</span> 
        <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">before</span><span class="p">[</span><span class="s1">&#39;plausible&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;first_guess&#39;</span> <span class="ow">in</span> <span class="n">before</span><span class="p">:</span> 
        <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">before</span><span class="p">[</span><span class="s1">&#39;first_guess&#39;</span><span class="p">]</span>
    <span class="n">after</span><span class="o">=</span><span class="n">at_station</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at_station</span><span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">dte</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">after</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StandardError</span><span class="p">(</span><span class="s1">&#39;No data for station </span><span class="si">%s</span><span class="s1"> after </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span>
                     <span class="n">dte</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">:%H:%M&quot;</span><span class="p">)))</span>
    <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># first row</span>
    <span class="k">if</span> <span class="s1">&#39;plausible&#39;</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span> 
        <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">after</span><span class="p">[</span><span class="s1">&#39;plausible&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;first_guess&#39;</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span> 
        <span class="n">quality</span><span class="o">=</span><span class="n">quality</span> <span class="o">&amp;</span> <span class="n">after</span><span class="p">[</span><span class="s1">&#39;first_guess&#39;</span><span class="p">]</span></div>
    <span class="k">return</span> <span class="n">quality</span>


<div class="viewcode-block" id="haversine"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.haversine">[docs]</a><span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate distance between two observations.</span>

<span class="sd">    Args:</span>
<span class="sd">        origin (:obj:`pandas.DataFrame`): 1 row from an observations dataframe. Must have columns &#39;latitude&#39; and &#39;longitude&#39;.</span>
<span class="sd">        destination (:obj:`pandas.DataFrame`): 1 row from an observations dataframe. Must have columns &#39;latitude&#39; and &#39;longitude&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :obj:`float`: Distance between origin and destination in km.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dlat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">latitude</span><span class="o">-</span><span class="n">destination</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">longitude</span><span class="o">-</span><span class="n">destination</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
              <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span> \
        <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">destination</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span> \
        <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">6371</span> <span class="o">*</span> <span class="n">c</span> <span class="c1"># Earth radius in km</span>
</div>
    <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="nearby_observations"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.nearby_observations">[docs]</a><span class="k">def</span> <span class="nf">nearby_observations</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">distance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the subset of observations within a given distance of a target.</span>

<span class="sd">    Args:</span>
<span class="sd">        observations (:obj:`pandas.DataFrame`): Observations dataframe. Must have columns &#39;latitude&#39; and &#39;longitude&#39;.</span>
<span class="sd">        target (:obj:`pandas.DataFrame`): 1 row from an observations dataframe. Must have columns &#39;latitude&#39; and &#39;longitude&#39;.</span>
<span class="sd">        distance (:obj:`float`): Maximum distance (km).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (:obj:`pandas.DataFrame`): Observations dataframe. Same as &#39;observations&#39; input except that it only contains rows less than &#39;distance&#39; from &#39;target&#39;.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">selected</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">haversine</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">observations</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">&lt;</span><span class="n">distance</span><span class="p">:</span>
            <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">observations</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span>

<div class="viewcode-block" id="buddy_check"><a class="viewcode-back" href="../../modules/module_DIYA.html#DIYA.buddy_check">[docs]</a><span class="k">def</span> <span class="nf">buddy_check</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">obs_error</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">lat_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span><span class="n">lon_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">360</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Checks the influence of assimilating each ob on its neighbours.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs (:obj:`pandas.DataFrame`): Observations. Dataframe must have columns &#39;latitude&#39;, &#39;longitude&#39;, &#39;value&#39;, and &#39;dtm&#39; - the last a datetime.datetime.</span>
<span class="sd">       field (:obj:`iris.Cube.cube`): Reanalysis ensemble field to assimilate to - dimensions lat, lon, ensemble.</span>

<span class="sd">    For each observation, assimilate into the field provided, then compare all the other observations to the field both before and after assimilation. For each ob, return the ratio of this mean difference with::without assimilation (&lt;1 is good, observation improves fit to buddies, &gt;1 is bad, degrades fit).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (:obj:`pandas.Series`):  Mean difference ratio from assimilating each observation.</span>

<span class="sd">    |</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="c1"># Mean difference for each ob without assimilation</span>
    <span class="n">e_o</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span><span class="o">.</span><span class="n">interpolator</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> 
                                   <span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
        <span class="n">ensemble</span><span class="o">=</span><span class="n">interpolator</span><span class="p">([</span><span class="n">obs</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">obs</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
        <span class="n">e_o</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Effect of assimilating each ob</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
        <span class="n">new_field</span><span class="o">=</span><span class="n">DIYA</span><span class="o">.</span><span class="n">constrain_cube</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                      <span class="n">obs_error</span><span class="o">=</span><span class="n">obs_error</span><span class="p">,</span>
                                      <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                      <span class="n">lat_range</span><span class="o">=</span><span class="n">lat_range</span><span class="p">,</span>
                                      <span class="n">lon_range</span><span class="o">=</span><span class="n">lon_range</span><span class="p">)</span>

        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">()</span><span class="o">.</span><span class="n">interpolator</span><span class="p">(</span><span class="n">new_field</span><span class="p">,</span> 
                                       <span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
        <span class="n">ms_o</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ms_n</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">id2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">id2</span><span class="o">==</span><span class="n">idx</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">ms_o</span> <span class="o">=</span> <span class="n">ms_o</span> <span class="o">+</span> <span class="n">e_o</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ensemble</span><span class="o">=</span><span class="n">interpolator</span><span class="p">([</span><span class="n">obs</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="n">id2</span><span class="p">],</span><span class="n">obs</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="n">id2</span><span class="p">]])</span>
            <span class="n">ms_n</span> <span class="o">=</span> <span class="n">ms_n</span> <span class="o">+</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">id2</span><span class="p">]</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms_n</span><span class="o">/</span><span class="n">ms_o</span>
</div>
    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Offline assimilation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>